/*! AILA Chat Widget v1.0.0 - UMD Bundle - Production | MIT License */
!(function (e, t) {
  "object" == typeof exports && "undefined" != typeof module
    ? (module.exports = t())
    : "function" == typeof define && define.amd
      ? define(t())
      : ((e = e || self), (e.AILAChat = t()));
})(this, function () {
  "use strict";
  class AILAChatWidget {
    constructor(e = {}) {
      ((this.webhookUrl = e.webhookUrl || ""),
        (this.welcomeMessage =
          e.welcomeMessage || "Hello! How can I help you today?"),
        (this.position = e.position || "bottom-right"),
        (this.isOpen = !1),
        (this.messages = []),
        (this.isTyping = !1),
        (this.sessionId = this.getSessionId()),
        this.createElements(),
        this.bindEvents());
    }
    getSessionId() {
      let e = sessionStorage.getItem("aila_session_id");
      return (
        e ||
          ((e =
            "guest_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9)),
          sessionStorage.setItem("aila_session_id", e)),
        e
      );
    }
    hideFloatingText() {
      this.floatingText && (this.floatingText.style.display = "none");
    }
    createElements() {
      ((this.launcher = document.createElement("div")),
        (this.launcher.className = "aila-chat-launcher"),
        this.launcher.setAttribute("aria-label", "Open chat"),
        this.launcher.setAttribute("role", "button"),
        this.launcher.setAttribute("tabindex", "0"),
        (this.launcher.innerHTML = `<img src="./icon.png" alt="AILA" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;"><div class="aila-floating-text">Chat with AILA</div>`),
        (this.floatingText = this.launcher.querySelector(
          ".aila-floating-text",
        )),
        (this.container = document.createElement("div")),
        (this.container.className = "aila-chat-container"),
        this.container.setAttribute("aria-hidden", "true"),
        (this.container.innerHTML = `<div class="aila-chat-header"><h3>AILA CHATBOT</h3><button class="aila-chat-close" aria-label="Close chat"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div><div class="aila-chat-messages" role="log" aria-live="polite"></div><div class="aila-chat-input-container"><div style="position: relative; flex: 1; display: flex; align-items: center;"><textarea class="aila-chat-input" placeholder="Type your message..." rows="1" aria-label="Type your message"></textarea><button class="aila-chat-send aila-send-active" aria-label="Send message"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div></div>`),
        (this.messagesContainer = this.container.querySelector(
          ".aila-chat-messages",
        )),
        (this.input = this.container.querySelector(".aila-chat-input")),
        (this.sendButton = this.container.querySelector(".aila-chat-send")),
        this.sendButton.classList.add("aila-send-active"),
        (this.closeButton = this.container.querySelector(".aila-chat-close")));
    }
    bindEvents() {
      (this.launcher.addEventListener("click", () => this.open()),
        this.launcher.addEventListener("keydown", (e) => {
          ("Enter" === e.key || " " === e.key) &&
            (e.preventDefault(), this.open());
        }),
        this.closeButton.addEventListener("click", () => this.close()),
        this.closeButton.addEventListener("keydown", (e) => {
          ("Enter" === e.key || " " === e.key) &&
            (e.preventDefault(), this.close());
        }),
        this.sendButton.addEventListener("click", () => this.sendMessage()),
        this.input.addEventListener("keydown", (e) => {
          "Enter" === e.key &&
            !e.shiftKey &&
            (e.preventDefault(), this.sendMessage());
        }),
        this.input.addEventListener("input", () => {
          ((this.input.style.height = "auto"),
            (this.input.style.height =
              Math.min(this.input.scrollHeight, 220) + "px"));
        }),
        document.addEventListener("keydown", (e) => {
          "Escape" === e.key && this.isOpen && this.close();
        }),
        (this.handleOutsideClick = (e) => {
          this.isOpen &&
            !this.container.contains(e.target) &&
            !this.launcher.contains(e.target) &&
            this.close();
        }),
        document.addEventListener("click", this.handleOutsideClick, !0));
    }
    mount() {
      (document.body.appendChild(this.container),
        document.body.appendChild(this.launcher));
    }
    open() {
      ((this.isOpen = !0),
        this.launcher.setAttribute("aria-expanded", "true"),
        this.container.setAttribute("aria-hidden", "false"),
        this.container.classList.add("aila-chat-open"),
        0 === this.messages.length &&
          this.addMessage(this.welcomeMessage, "bot"),
        setTimeout(() => this.input.focus(), 300));
    }
    close() {
      ((this.isOpen = !1),
        this.launcher.setAttribute("aria-expanded", "false"),
        this.container.setAttribute("aria-hidden", "true"),
        this.container.classList.remove("aila-chat-open"));
    }
    renderSafeMarkdown(e) {
      "string" != typeof e && (e = String(e || ""));
      let t = e.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return (t = t
        .replace(/&lt;br&gt;/g, "<br>")
        .replace(/&lt;\/br&gt;/g, "<br>")
        .replace(/&lt;br\s*\/?&gt;/g, "<br>")
        .replace(/&lt;strong&gt;/g, "<strong>")
        .replace(/&lt;\/strong&gt;/g, "</strong>")
        .replace(/&lt;b&gt;/g, "<strong>")
        .replace(/&lt;\/b&gt;/g, "</strong>")
        .replace(/&lt;em&gt;/g, "<em>")
        .replace(/&lt;\/em&gt;/g, "</em>")
        .replace(/&lt;i&gt;/g, "<em>")
        .replace(/&lt;\/i&gt;/g, "</em>")
        .replace(/&lt;code&gt;/g, "<code>")
        .replace(/&lt;\/code&gt;/g, "</code>")
        .replace(/&lt;pre&gt;/g, "<pre>")
        .replace(/&lt;\/pre&gt;/g, "</pre>")
        .replace(/&lt;p&gt;/g, "<p>")
        .replace(/&lt;\/p&gt;/g, "</p>")
        .replace(/&lt;div&gt;/g, "<div>")
        .replace(/&lt;\/div&gt;/g, "</div>")
        .replace(/&lt;span&gt;/g, "<span>")
        .replace(/&lt;\/span&gt;/g, "</span>")
        .replace(/&lt;ul&gt;/g, "<ul>")
        .replace(/&lt;\/ul&gt;/g, "</ul>")
        .replace(/&lt;ol&gt;/g, "<ol>")
        .replace(/&lt;\/ol&gt;/g, "</ol>")
        .replace(/&lt;li&gt;/g, "<li>")
        .replace(/&lt;\/li&gt;/g, "</li>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/__(.*?)__/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/_(.*?)_/g, "<em>$1</em>")
        .replace(/`([^`]+)`/g, "<code>$1</code>"));
    }
    addMessage(e, t = "user") {
      const s = document.createElement("div");
      return (
        (s.className = `aila-chat-message aila-chat-message-${t}`),
        "bot" === t
          ? (s.innerHTML = this.renderSafeMarkdown(e))
          : (s.textContent = e),
        this.messagesContainer.appendChild(s),
        this.messages.push({ content: e, type: t, timestamp: Date.now() }),
        (this.messagesContainer.scrollTop =
          this.messagesContainer.scrollHeight),
        s
      );
    }
    showTypingIndicator() {
      if (this.isTyping) return;
      this.isTyping = !0;
      const e = document.createElement("div");
      return (
        (e.className =
          "aila-chat-message aila-chat-message-bot aila-chat-typing"),
        (e.innerHTML = `<div class="aila-chat-typing"><span class="aila-chat-typing-dot"></span><span class="aila-chat-typing-dot"></span><span class="aila-chat-typing-dot"></span></div>`),
        this.messagesContainer.appendChild(e),
        (this.messagesContainer.scrollTop =
          this.messagesContainer.scrollHeight),
        e
      );
    }
    hideTypingIndicator(e) {
      (e && e.parentNode && e.parentNode.removeChild(e), (this.isTyping = !1));
    }
    async sendMessage() {
      const e = this.input.value.trim();
      if (!e) return;
      ((this.input.value = ""),
        (this.input.style.height = "auto"),
        this.addMessage(e, "user"));
      const t = this.showTypingIndicator();
      try {
        const s = await fetch(this.webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: e,
            sessionId: this.sessionId,
            timestamp: Date.now(),
          }),
        });
        if (!s.ok) throw new Error(`HTTP error! status: ${s.status}`);
        const i = s.headers.get("content-type");
        if (i && i.includes("text/plain")) {
          const i = s.body.getReader(),
            o = new TextDecoder();
          let a = "";
          this.hideTypingIndicator(t);
          const n = this.addMessage("", "bot");
          for (;;) {
            const { done: t, value: s } = await i.read();
            if (t) break;
            ((a += o.decode(s, { stream: !0 })),
              (n.textContent = a),
              (this.messagesContainer.scrollTop =
                this.messagesContainer.scrollHeight));
          }
        } else {
          const e = await s.json();
          (this.hideTypingIndicator(t),
            this.addMessage(
              e.reply ||
                e.response ||
                e.message ||
                "Sorry, I couldn't process that.",
              "bot",
            ));
        }
      } catch (e) {
        (console.error("Chat widget error:", e),
          this.hideTypingIndicator(t),
          this.addMessage(
            "Sorry, I'm having trouble connecting. Please try again later.",
            "bot",
          ));
      }
    }
    destroy() {
      (this.handleOutsideClick &&
        document.removeEventListener("click", this.handleOutsideClick, !0),
        this.launcher.remove(),
        this.container.remove());
    }
  }
  function createChat(e = {}) {
    if (!e.webhookUrl)
      return (console.error("AILA Chat: webhookUrl is required"), null);
    const t = {
        webhookUrl: e.webhookUrl,
        welcomeMessage: e.welcomeMessage || "Hello! How can I help you today?",
        position: e.position || "bottom-right",
        autoShow: e.autoShow === !1,
      },
      s = new AILAChatWidget(t);
    return (s.mount(), t.autoShow && setTimeout(() => s.open(), 1e3), s);
  }
  return { AILAChatWidget, createChat };
});
